<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shopify POS Pilot - Project Dashboard (Updated Feb 15, 2026)</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d1117;
  --surface: #161b22;
  --surface2: #1c2333;
  --border: #30363d;
  --border-light: #3d444d;
  --text: #e6edf3;
  --text-muted: #8b949e;
  --text-dim: #6e7681;
  --accent: #58a6ff;
  --accent-glow: rgba(88,166,255,0.15);
  --green: #3fb950;
  --green-bg: rgba(63,185,80,0.1);
  --yellow: #d29922;
  --yellow-bg: rgba(210,153,34,0.1);
  --red: #f85149;
  --red-bg: rgba(248,81,73,0.1);
  --purple: #bc8cff;
  --purple-bg: rgba(188,140,255,0.1);
  --orange: #f0883e;
  --tab-active: #58a6ff;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}
.mono { font-family: 'JetBrains Mono', monospace; }

/* TOP BAR */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(13,17,23,0.92);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex; align-items: center; justify-content: space-between;
  gap: 16px;
}
.topbar-left { display: flex; align-items: center; gap: 12px; }
.topbar-badge {
  background: var(--accent-glow);
  border: 1px solid var(--accent);
  color: var(--accent);
  font-size: 11px; font-weight: 600;
  padding: 3px 10px; border-radius: 20px;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.topbar h1 { font-size: 16px; font-weight: 600; }
.topbar-right { display: flex; align-items: center; gap: 16px; }
.progress-ring {
  display: flex; align-items: center; gap: 8px;
  font-size: 13px; color: var(--text-muted);
}
.progress-ring strong { color: var(--green); font-size: 15px; }

/* TABS */
.tab-bar {
  position: sticky; top: 53px; z-index: 99;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: center; overflow-x: auto; gap: 0;
  scrollbar-width: none;
}
.tab-bar::-webkit-scrollbar { display: none; }
.tab {
  padding: 10px 18px;
  font-size: 13px; font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  white-space: nowrap;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  user-select: none;
}
.tab:hover { color: var(--text); background: rgba(255,255,255,0.03); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab .tab-count {
  font-size: 10px; margin-left: 5px;
  background: var(--border);
  padding: 1px 6px; border-radius: 10px;
}

/* MAIN */
.main { max-width: 1200px; margin: 0 auto; padding: 24px; }
.panel { display: none; }
.panel.active { display: block; }

/* CARDS */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}
.card-header {
  padding: 14px 18px;
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.card-header:hover { background: rgba(255,255,255,0.02); }
.card-header h3 {
  font-size: 14px; font-weight: 600;
  display: flex; align-items: center; gap: 8px;
}
.card-header .arrow {
  color: var(--text-dim);
  transition: transform 0.2s;
  font-size: 12px;
}
.card-header .arrow.open { transform: rotate(90deg); }
.card-body { padding: 0 18px 16px; }
.card-progress {
  font-size: 12px; color: var(--text-muted);
  display: flex; align-items: center; gap: 8px;
}
.card-progress .bar {
  width: 60px; height: 4px;
  background: var(--border);
  border-radius: 2px; overflow: hidden;
}
.card-progress .bar-fill {
  height: 100%; border-radius: 2px;
  background: var(--green);
  transition: width 0.3s;
}

/* TABLES */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
th {
  text-align: left;
  padding: 8px 12px;
  color: var(--text-muted);
  font-weight: 500;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
  background: rgba(0,0,0,0.2);
}
td {
  padding: 8px 12px;
  border-bottom: 1px solid rgba(48,54,61,0.5);
  color: var(--text);
  vertical-align: top;
}
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(255,255,255,0.015); }

/* CHECKBOXES */
.check-row { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; }
.check-row + .check-row { border-top: 1px solid rgba(48,54,61,0.4); }
.check-box {
  width: 18px; height: 18px; min-width: 18px;
  border: 2px solid var(--border-light);
  border-radius: 4px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
  margin-top: 1px;
  flex-shrink: 0;
}
.check-box:hover { border-color: var(--accent); }
.check-box.checked {
  background: var(--green);
  border-color: var(--green);
}
.check-box.checked::after {
  content: 'âœ“';
  color: #fff;
  font-size: 12px;
  font-weight: 700;
}
.check-label { font-size: 13px; flex: 1; text-align: left; }
.check-label.done { color: var(--text-dim); text-decoration: line-through; }
.check-num { font-family: 'JetBrains Mono', monospace; color: var(--accent); min-width: 20px; font-size: 12px; font-weight: 600; flex-shrink: 0; text-align: left; }
.check-notes {
  font-size: 12px; color: var(--text-dim);
  min-width: 160px; text-align: right;
  flex-shrink: 0;
}

/* BADGES */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.badge-high { background: var(--red-bg); color: var(--red); }
.badge-normal { background: var(--yellow-bg); color: var(--yellow); }
.badge-green { background: var(--green-bg); color: var(--green); }
.badge-purple { background: var(--purple-bg); color: var(--purple); }
.badge-descoped { background: rgba(110,118,129,0.15); color: var(--text-dim); text-decoration: line-through; }

/* FLOW DIAGRAM */
.flow {
  display: flex; align-items: stretch; gap: 0;
  overflow-x: auto; padding: 16px 0;
}
.flow-step {
  display: flex; flex-direction: column; align-items: center;
  min-width: 120px; flex: 1; position: relative;
}
.flow-step::after {
  content: 'â†’';
  position: absolute; right: -8px; top: 18px;
  color: var(--text-dim); font-size: 16px;
}
.flow-step:last-child::after { display: none; }
.flow-icon {
  width: 40px; height: 40px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; margin-bottom: 8px;
}
.flow-title { font-size: 11px; font-weight: 600; text-align: center; }
.flow-sub { font-size: 10px; color: var(--text-dim); text-align: center; margin-top: 2px; }

/* TIMELINE */
.timeline { position: relative; padding-left: 24px; }
.timeline::before {
  content: '';
  position: absolute; left: 7px; top: 4px; bottom: 4px;
  width: 2px; background: var(--border);
}
.tl-item { position: relative; margin-bottom: 20px; }
.tl-item::before {
  content: '';
  position: absolute; left: -21px; top: 6px;
  width: 10px; height: 10px;
  border-radius: 50%;
  border: 2px solid var(--accent);
  background: var(--bg);
}
.tl-item.done::before { background: var(--green); border-color: var(--green); }
.tl-phase {
  font-size: 12px; font-weight: 600;
  color: var(--accent); margin-bottom: 4px;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.tl-title { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
.tl-detail { font-size: 12px; color: var(--text-muted); }

/* STAT GRID */
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.stat {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
}
.stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.stat-value { font-size: 22px; font-weight: 700; }
.stat-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

/* SECTION HEADERS */
.section-title {
  font-size: 18px; font-weight: 700;
  margin: 24px 0 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.section-title:first-child { margin-top: 0; }
.section-sub {
  font-size: 13px; color: var(--text-muted);
  margin: -8px 0 16px;
}

/* INFO BOX */
.info-box {
  background: var(--accent-glow);
  border: 1px solid rgba(88,166,255,0.3);
  border-radius: 8px;
  padding: 14px 16px;
  font-size: 13px;
  margin-bottom: 16px;
  line-height: 1.5;
}
.info-box.warn {
  background: var(--yellow-bg);
  border-color: rgba(210,153,34,0.3);
}
.info-box.success {
  background: var(--green-bg);
  border-color: rgba(63,185,80,0.3);
}
.info-box strong { color: var(--accent); }
.info-box.warn strong { color: var(--yellow); }

/* PERMISSION MATRIX */
.perm-grid { display: grid; gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden; }
.perm-cell {
  padding: 8px 12px;
  font-size: 12px;
  background: var(--surface);
}
.perm-header {
  background: var(--surface2);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  color: var(--text-muted);
}
.perm-yes { color: var(--green); }
.perm-no { color: var(--red); }
.perm-label { font-weight: 500; }

/* COST BAR */
.cost-compare {
  display: flex; gap: 16px; margin: 16px 0;
}
.cost-bar-container { flex: 1; }
.cost-bar-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
.cost-bar-wrap { background: var(--border); border-radius: 6px; overflow: hidden; height: 28px; position: relative; }
.cost-bar-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; padding: 0 10px; font-size: 12px; font-weight: 600; }

/* SPRINT VIEW */
.sprint-day {
  display: grid;
  grid-template-columns: 80px 1fr;
  gap: 0;
  margin-bottom: 2px;
}
.sprint-day-label {
  padding: 10px 12px;
  font-size: 12px; font-weight: 600;
  color: var(--accent);
  background: var(--surface2);
  border-right: 2px solid var(--accent);
  display: flex; align-items: center;
}
.sprint-day-tasks {
  padding: 6px 12px;
  display: flex; flex-wrap: wrap; gap: 6px;
  align-items: center;
  background: var(--surface);
}
.sprint-task {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: var(--surface2);
  white-space: nowrap;
}
.sprint-task.crit { border-color: var(--red); color: var(--red); }
.sprint-task.done { border-color: var(--green); color: var(--green); opacity: 0.8; }
.sprint-day-label.done { color: var(--green); }

/* ROLE DIAGRAM */
.role-stack { display: flex; flex-direction: column; gap: 8px; margin: 16px 0; }
.role-box {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.role-box.hq { border-color: var(--purple); background: var(--purple-bg); }
.role-box.mgr { border-color: var(--accent); background: var(--accent-glow); }
.role-box.dist { border-color: var(--green); background: var(--green-bg); }
.role-name { font-weight: 600; font-size: 14px; }
.role-detail { font-size: 12px; color: var(--text-muted); }

/* RESPONSIVE */
@media (max-width: 768px) {
  .topbar { padding: 10px 16px; flex-wrap: wrap; }
  .main { padding: 16px; }
  .stats { grid-template-columns: repeat(2, 1fr); }
  .tab { padding: 8px 12px; font-size: 12px; }
  .flow { flex-wrap: wrap; }
  .flow-step { min-width: 90px; }
  .flow-step::after { display: none; }
  .cost-compare { flex-direction: column; }
}

/* PRINT */
@media print {
  .topbar, .tab-bar { position: static; }
  .panel { display: block !important; page-break-inside: avoid; }
  .card-body { display: block !important; }
}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-badge">TKT-5793</span>
    <h1>Shopify POS Distributor Pilot &mdash; USA</h1>
  </div>
  <div class="topbar-right">
    <div class="progress-ring">
      <div style="text-align:center"><div style="font-size:10px;color:var(--text-dim)">Tickets</div><strong id="ticketProgress">0%</strong></div>
      <div style="width:1px;height:24px;background:var(--border)"></div>
      <div style="text-align:center"><div style="font-size:10px;color:var(--text-dim)">Go-Live</div><strong id="globalProgress">0%</strong></div>
    </div>
    <div style="font-size:12px;color:var(--text-dim)">Launch: Feb 21</div>
  </div>
</div>

<div class="tab-bar" id="tabBar"></div>

<div class="main" id="mainContent"></div>

<script>
// ================================================
// STATE
// ================================================
const state = {
  activeTab: 0,
  checks: {
    'tkt1': true, 'tkt2': true, 'tkt3': true, 'tkt4': true, 'tkt5': true, 'tkt7': true, 'tkt8': true,
    'tkt19': true, 'tkt20': true, 'tkt21': true, 'tkt22': true, 'tkt23': true, 'tkt25': true,
    'gl_platform_0': true, 'gl_platform_1': true, 'gl_platform_2': true, 'gl_platform_3': true,
    'gl_platform_4': true, 'gl_platform_5': true,
    'gl_roles_0': true, 'gl_roles_1': true, 'gl_roles_2': true, 'gl_roles_3': true, 'gl_roles_5': true,
    'gl_csv_0': true, 'gl_csv_1': true
  },
  collapsed: {}
};

// Helper to toggle checks
function toggleCheck(id) {
  state.checks[id] = !state.checks[id];
  render();
}
function isChecked(id) { return !!state.checks[id]; }

function toggleCollapse(id) {
  state.collapsed[id] = !state.collapsed[id];
  render();
}
function isCollapsed(id) { return !!state.collapsed[id]; }

// ================================================
// CHECKLIST DATA
// ================================================
const goLiveChecks = {
  platform: [
    'Shopify Plus plan active',
    'Shopify Payments enabled and bank verified',
    'POS Pro active on US-Pilot location',
    'Products available at pilot location with correct pricing',
    '711 MS customers preloaded with metafields',
    'Password protection removed from Online Store'
  ],
  hardware: [
    'All 10 readers received and unboxed',
    'All 10 readers fully charged',
    'All 10 readers paired to distributor iPhones',
    'Firmware updated on all 10 readers',
    'Test transaction on each reader',
    'Serial numbers documented and mapped',
    'USB-C cables distributed',
    'Each reader labeled with distributor name/ID'
  ],
  roles: [
    '"Distributor" POS role created and verified',
    '"POS Manager" POS role created and verified',
    '"Regional Manager" store role created and verified',
    'Regional manager onboarded with both roles',
    'All 10 distributors onboarded as POS-only staff',
    'All PINs set and tested'
  ],
  attribution: [
    'Sales attribution enabled (auto-attribution mode)',
    'Staff name to Unicity ID mapping table complete',
    'Test sale shows correct "Attributed to" on order',
    'Sales by Staff report accurate',
    'Customer email matching validated (Scenario A)',
    'Orphan handling confirmed (Scenario B/C)'
  ],
  csv: [
    'CSV export process documented and tested',
    'Export includes all required fields',
    'Staff name mapping validated in CSV',
    'Unity import process confirmed with data team',
    'Test import completed successfully',
    'Subscription orders identifiable in CSV',
    'Daily export schedule and owner assigned'
  ],
  subscriptions: [
    'Subscription app installed and configured',
    'Selling plans created for pilot products',
    'Test subscription token vaulted',
    'Test renewal charged',
    'Failed payment retry and notification working'
  ],
  security: [
    'Data isolation verified',
    ' 2FA enabled for regional manager',
    'Distributors confirmed blocked from admin',
    'Pricing change policy communicated'
  ],
  testing: [
    'All E2E test scenarios passed',
    'POS sale attributed correctly (card reader)',
    'POS sale attributed correctly (Tap to Pay)',
    'Online sale with referral code captured',
    'CSV export matches Shopify dashboard totals',
    'Settlement reconciliation verified'
  ],
  training: [
    'All distributors have POS app installed',
    'All distributors confirmed PIN working',
    'All distributors confirmed reader working',
    'Training materials distributed',
    'Escalation path communicated',
    'CSV export schedule communicated'
  ],
  gonogo: [
    'All pre-launch items verified',
    'Stakeholder sign-off obtained',
    'Daily monitoring process defined',
    'Rollback plan documented',
    'PILOT DECLARED LIVE'
  ]
};

const e2eTests = [
  { id: 'e2e1', name: 'POS sale via card reader', steps: 'PIN login â†’ add product â†’ customer taps card', expect: 'Order created, source="pos", correct attribution' },
  { id: 'e2e2', name: 'POS sale via Tap to Pay', steps: 'Same flow, customer taps iPhone directly', expect: 'Same result (backup method verified)' },
  { id: 'e2e3', name: 'POS sale with subscription', steps: 'Add subscription product, capture email, card pay', expect: 'selling_plan on line item, token vaulted' },
  { id: 'e2e4', name: 'Subscription renewal', steps: 'Wait for billing cycle or trigger manually', expect: 'Auto-charge on vaulted token, new order' },
  { id: 'e2e5', name: 'Failed subscription payment', steps: 'Use test card that declines', expect: 'Retry logic triggers, customer notified' },
  { id: 'e2e6', name: 'Online sale with referral', steps: 'Customer uses referral link, checkout', expect: 'source="web", referral code captured' },
  { id: 'e2e7', name: 'Manager processes return', steps: 'Manager login â†’ find order â†’ process return', expect: 'Refund issued via Shopify Payments' },
  { id: 'e2e8', name: 'Manager adds distributor', steps: 'Manager POS app â†’ Staff â†’ Add staff', expect: 'New distributor can process sales' },
  { id: 'e2e9', name: 'Data isolation: Dist A vs B', steps: 'Dist A sale â†’ logout â†’ Dist B login', expect: 'Dist B cannot see Dist A sale' },
  { id: 'e2e10', name: 'Data isolation: Admin', steps: 'Distributor attempts admin URL', expect: 'Blocked, no admin access' },
  { id: 'e2e11', name: 'Attribution accuracy', steps: '5 sales across 3 distributors', expect: 'Sales by Staff report correct for each' },
  { id: 'e2e12', name: 'CSV export accuracy', steps: 'Export orders CSV after test sales', expect: 'All fields present and correct' },
  { id: 'e2e13', name: 'CSV staff name mapping', steps: 'Apply lookup table to exported CSV', expect: 'All staff names map to Unicity IDs' },
  { id: 'e2e14', name: 'Settlement reconciliation', steps: 'Check Shopify payout vs order totals', expect: 'Match (minus fees/refunds)' }
];

const tickets = [
  { n:1, name:'Create Regional POS Location', pri:'High', dep:'Plus plan active', effort:'15 min', phase:1, link:'86dztj289' },
  { n:2, name:'Activate POS Pro on Pilot Location', pri:'High', dep:'Ticket 1', effort:'5 min', phase:1, link:'86dztj2dq' },
  { n:3, name:'Create POS Roles', pri:'High', dep:'Ticket 2', effort:'30 min', phase:1, link:'86dztj2h0' },
  { n:4, name:'Create Store-Level Role for Regional Manager', pri:'High', dep:'None', effort:'20 min', phase:1, link:'86dztj2jx', done:true },
  { n:5, name:'Add Regional Manager User Account', pri:'High', dep:'Tickets 3, 4', effort:'15 min + 7d invite', phase:1, link:'86dztj2mn', done:true },
  { n:6, name:'Onboard 10 Distributors as POS-Only Staff', pri:'High', dep:'Tickets 1, 3', effort:'1 hour', phase:1, link:'86dztj2pn' },
  { n:7, name:'Configure Product Catalog for POS Location', pri:'Normal', dep:'Ticket 1', effort:'1-2 hours', phase:1, link:'86dztj2r3', done:true },
  { n:8, name:'Verify Shopify Payments Configuration', pri:'High', dep:'Plus plan active', effort:'30 min', phase:1, link:'86dztj2un' },
  { n:18, name:'Set Up and Pair 10 Shopify Card Readers', pri:'High', dep:'Tickets 6, 8', effort:'2-3 hours', phase:1, link:'86dztj5bf' },
  { n:20, name:'Install Headless Sales Channel + Storefront API', pri:'High', dep:'Plus plan active', effort:'30 min', phase:1, link:'86dztjaur', done:true },
  { n:21, name:'Send Storefront API Credentials to Colby Cook', pri:'High', dep:'Ticket 20', effort:'10 min', phase:1, link:'86dztjaur', done:true },
  { n:22, name:'Team Architecture Alignment', pri:'High', dep:'Ticket 20', effort:'30 min', phase:1, link:'86dztjaur', done:true },
  { n:23, name:'Delete KnockBase Dev Dashboard App', pri:'Low', dep:'None', effort:'5 min', phase:1, link:'86dztjaur', done:true },
  { n:25, name:'Bulk Import MS Customers (711 preloaded)', pri:'High', dep:'Ticket 1', effort:'4 hours', phase:1, link:'86dztj228', done:true },
  { n:9, name:'Configure POS Sales Attribution', pri:'High', dep:'Tickets 2, 6', effort:'30 min', phase:2, link:'86dztj2x3' },
  { n:12, name:'Configure Subscriptions / Autoship', pri:'High', dep:'Ticket 8', effort:'1 week', phase:2, link:'86dztj390' },
  { n:19, name:'CSV Export Process and Unity Database Import', pri:'High', dep:'Tickets 6, 9', effort:'1-2 days', phase:2, link:'86dztjaur', done:true },
  { n:26, name:'Shopify-Unity Order Sync Automation', pri:'High', dep:'Ticket 19', effort:'1-2 weeks', phase:2, link:'86dzugv8m' },
  { n:10, name:'Build Attribution Middleware', pri:'DESCOPED', dep:'â€”', effort:'â€”', phase:'X', link:'86dztj2zy' },
  { n:11, name:'Commission Engine Integration', pri:'DESCOPED', dep:'â€”', effort:'â€”', phase:'X', link:'86dztj33q' },
  { n:13, name:'Data Isolation Validation', pri:'High', dep:'Ticket 6', effort:'2-3 hours', phase:3, link:'86dztj3az' },
  { n:14, name:'End-to-End Testing (incl. CSV)', pri:'High', dep:'All previous', effort:'1-2 days', phase:3, link:'86dztj3ee' },
  { n:15, name:'Reconciliation Setup', pri:'Normal', dep:'Tickets 9, 19', effort:'1-2 days', phase:3, link:'86dztj3jd' },
  { n:16, name:'Training Materials and PIN Distribution', pri:'Normal', dep:'Tickets 5, 6', effort:'1-2 days', phase:3, link:'86dztj3nt' },
  { n:17, name:'Go-Live Checklist and Launch Validation', pri:'High', dep:'All previous', effort:'1 day', phase:3, link:'86dztj3tf' },
];

// ================================================
// TABS
// ================================================
const tabs = [
  { label: 'Overview', icon: 'â—‰' },
  { label: 'Payments', icon: 'ðŸ’³' },
  { label: 'Data Flow', icon: 'â†“' },
  { label: 'Permissions', icon: 'ðŸ”’' },
  { label: 'Tickets', icon: '#' },
  { label: 'Sprint Plan', icon: 'âš¡' },
  { label: 'Hardware', icon: 'â¬¡' },
  { label: 'Subscriptions', icon: 'â†»' },
  { label: 'Onboarding', icon: 'â†’' },
  { label: 'Testing', icon: 'âœ“' },
  { label: 'Go-Live', icon: 'ðŸš€' },
  { label: 'Monitoring', icon: 'â—Ž' },
];

// URL hash routing: #overview, #payments, #permissions, etc.
function tabSlug(label) { return label.toLowerCase().replace(/[^a-z0-9]+/g, '-'); }
function getTabFromHash() {
  try {
    const hash = location.hash.replace('#','').toLowerCase();
    if (!hash) return 0;
    const idx = tabs.findIndex(t => tabSlug(t.label) === hash);
    return idx >= 0 ? idx : 0;
  } catch(e) { return 0; }
}
function setTab(i) {
  state.activeTab = i;
  try { history.replaceState(null, '', '#' + tabSlug(tabs[i].label)); } catch(e) {}
  render();
}
try { window.addEventListener('hashchange', () => { state.activeTab = getTabFromHash(); render(); }); } catch(e) {}

// ================================================
// RENDER HELPERS
// ================================================
function h(tag, attrs, ...children) {
  const el = document.createElement(tag);
  if (attrs) Object.entries(attrs).forEach(([k,v]) => {
    if (k === 'className') el.className = v;
    else if (k === 'style' && typeof v === 'object') Object.assign(el.style, v);
    else if (k.startsWith('on')) el.addEventListener(k.slice(2).toLowerCase(), v);
    else el.setAttribute(k, v);
  });
  children.flat(3).forEach(c => {
    if (c == null) return;
    el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return el;
}

function checklistCard(title, sectionId, items, prefix) {
  const checked = items.filter((_,i) => isChecked(prefix+i)).length;
  const total = items.length;
  const pct = total ? Math.round(checked/total*100) : 0;
  const open = !isCollapsed(sectionId);

  return h('div', { className: 'card' },
    h('div', { className: 'card-header', onClick: () => toggleCollapse(sectionId) },
      h('h3', null,
        h('span', { className: 'arrow ' + (open?'open':'') }, 'â–¶'),
        title
      ),
      h('div', { className: 'card-progress' },
        h('span', null, `${checked}/${total}`),
        h('div', { className: 'bar' },
          h('div', { className: 'bar-fill', style: { width: pct+'%', background: pct===100?'var(--green)':pct>50?'var(--yellow)':'var(--accent)' } })
        ),
        h('span', null, pct + '%')
      )
    ),
    open ? h('div', { className: 'card-body' },
      ...items.map((item, i) => {
        const id = prefix + i;
        const done = isChecked(id);
        return h('div', { className: 'check-row' },
          h('div', { className: 'check-box' + (done?' checked':''), onClick: () => toggleCheck(id) }),
          h('span', { className: 'check-label' + (done?' done':'') }, item)
        );
      })
    ) : null
  );
}

function getGlobalProgress() {
  let total = 0, checked = 0;
  Object.entries(goLiveChecks).forEach(([key, items]) => {
    items.forEach((_, i) => {
      total++;
      if (isChecked('gl_'+key+'_'+i)) checked++;
    });
  });
  e2eTests.forEach(t => { total++; if (isChecked(t.id)) checked++; });
  return total ? Math.round(checked/total*100) : 0;
}

function getTicketProgress() {
  const active = tickets.filter(t => t.phase !== 'X');
  const done = active.filter(t => isChecked('tkt'+t.n)).length;
  return active.length ? Math.round(done/active.length*100) : 0;
}

// ================================================
// PANEL RENDERERS
// ================================================
function renderOverview() {
  return h('div', null,
    // Stats
    h('div', { className: 'stats' },
      ...[
        { label:'Location', value:'1', sub:'US-Pilot' },
        { label:'Customers', value:'711', sub:'MS preloaded' },
        { label:'Products', value:'4', sub:'Pilot SKUs' },
        { label:'Distributors', value:'10', sub:'POS-only staff' },
        { label:'Card Readers', value:'10', sub:'$49 each' },
        { label:'POS Rate', value:'2.3%', sub:'+ 10Â¢ card present' },
        { label:'Timeline', value:'6 days', sub:'Due Feb 21' },
        { label:'Tickets Done', value:'13/23', sub:'2 descoped' },
      ].map(s => h('div', { className: 'stat' },
        h('div', { className: 'stat-label' }, s.label),
        h('div', { className: 'stat-value' }, s.value),
        h('div', { className: 'stat-sub' }, s.sub)
      ))
    ),

    h('div', { className: 'info-box' },
      h('strong', null, 'Executive Summary: '),
      'This pilot validates the Shopify POS distributor model with 1 regional manager, 10 distributors, and subscription (autoship) capability in the US market. Distributors use the Shopify POS app on iPhones with Bluetooth card readers. Every sale auto-attributes to the distributor via staff_id. No commission engine on Shopify. No middleware. Daily CSV export to Unity database. Email is the join key between Shopify and Unity. ',
      h('span', { style: { color:'var(--green)' } }, 'Completed (13/23): Location, POS Pro, Roles, Store Role, Manager Account, Payments, Headless API, Team Alignment, Products (4 SKUs), Customers (711 MS imported), CSV Export, KnockBase deleted, Architecture. '),
      h('span', { style: { color:'var(--yellow)' } }, 'Remaining: Distributor onboarding, card readers, attribution, subscriptions, testing, password removal.')
    ),

    h('div', { className: 'section-title' }, 'Architecture Stack'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Layer'), h('th', null, 'Component'), h('th', null, 'Pilot Config')
          )),
          h('tbody', null,
            ...([
              ['Distributor','POS-only staff, PIN access, zero admin','10 accounts, $0 each'],
              ['Manager','Admin + POS staff, limited store access','1 account, $0'],
              ['Location','POS Pro territory','1 location (US-Pilot)'],
              ['Products','4 pilot SKUs, active on all channels','Balance Orange/Berry, Diamond, Unimate'],
              ['Customers','711 MS accounts preloaded via CSV','Email matching for POS attribution'],
              ['Metafields','4 custom fields on customer records','unicity_id, status, subscription, origin'],
              ['Pricing','Compare at dual-tier strategy','Wholesale=Price, Retail=Compare at'],
              ['Hardware','Shopify Tap & Chip readers','10 readers ($49 each)'],
              ['Backup','iPhone Tap to Pay (NFC)','Distributor phone, $0'],
              ['Payment','Shopify Payments (Stripe)','POS: 2.3%+10Â¢ / Online: 2.25%+30Â¢'],
              ['Subscriptions','Selling Plan APIs + token vault','Auto-charge vaulted cards'],
              ['Attribution','POS Pro sales by staff','Staff name on each order'],
              ['Data Export','CSV from Shopify Admin','Daily manual export'],
              ['Data Import','Batch import to Unity','Bryan Simmons'],
              ['Commission','Existing InfoTrax pipeline','No change'],
            ].map(r => h('tr', null, ...r.map(c => h('td', null, c)))))
          )
        )
      )
    ),

    h('div', { className: 'section-title' }, 'NOT in Scope'),
    h('div', { className: 'info-box warn' },
      h('strong', null, 'Descoped: '), 'Webhook middleware (CSV replaces it), Commission engine on Shopify (stays in InfoTrax), Real-time order sync (daily batch sufficient), Shopify Flow automation (manual manageable at this scale).'
    ),

    h('div', { className: 'section-title' }, 'Key Concept: Location = Territory'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Shopify Term'), h('th', null, 'Business Term'), h('th', null, 'Pilot'), h('th', null, 'Max at Scale')
          )),
          h('tbody', null,
            h('tr', null, h('td', null, 'Location'), h('td', null, 'Territory / Branch'), h('td', null, '1 (US-Pilot)'), h('td', null, '200 (Plus cap)')),
            h('tr', null, h('td', null, 'Admin + POS Staff'), h('td', null, 'Territory Manager'), h('td', null, '1'), h('td', null, '1 per territory')),
            h('tr', null, h('td', null, 'POS-Only Staff'), h('td', null, 'Distributor'), h('td', null, '10'), h('td', null, 'Unlimited, $0'))
          )
        ),
        h('div', { className: 'info-box', style: { marginTop:'12px', marginBottom:'0' } },
          'A location is NOT a person. All 10 distributors share one location. The 200-location cap is a territory cap, not a distributor cap.'
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Control Hierarchy'),
    h('div', { className: 'role-stack' },
      h('div', { className: 'role-box hq' },
        h('div', null, h('div', { className: 'role-name' }, 'HQ Admin'), h('div', { className: 'role-detail' }, 'Full store owner + all POS')),
        h('div', null, h('span', { className: 'badge badge-purple' }, '2-3 people'))
      ),
      h('div', { className: 'role-box mgr' },
        h('div', null, h('div', { className: 'role-name' }, 'Regional Manager'), h('div', { className: 'role-detail' }, 'Limited admin (Products, Customers, Orders) + POS Manager')),
        h('div', null, h('span', { className: 'badge', style: { background:'var(--accent-glow)', color:'var(--accent)' } }, '1 person'))
      ),
      h('div', { className: 'role-box dist' },
        h('div', null, h('div', { className: 'role-name' }, 'Distributor'), h('div', { className: 'role-detail' }, 'No admin access. POS checkout only.')),
        h('div', null, h('span', { className: 'badge badge-green' }, '10 people, $0'))
      )
    )
  );
}

function renderPayments() {
  return h('div', null,
    h('div', { className: 'info-box success' },
      h('strong', null, 'Ticket 8 COMPLETE '), 'â€” Shopify Payments verified on both Online and In-person tabs. Shop Pay Installments disabled for POS (BNPL not appropriate for Unicity products). All card types and NFC wallets enabled.'
    ),

    h('div', { className: 'stats' },
      ...[
        { label:'POS Card Present', value:'2.3%', sub:'+ $0.10' },
        { label:'POS Manual Entry', value:'3.4%', sub:'+ $0.10' },
        { label:'Online Domestic', value:'2.25%', sub:'+ $0.30 (standard)' },
        { label:'Online International', value:'3.25%', sub:'+ $0.30' },
        { label:'PayPal Domestic', value:'3.49%', sub:'+ $0.49' },
        { label:'ACH Direct Debit', value:'1.0%', sub:'Cap $7.50' },
      ].map(s => h('div', { className: 'stat' },
        h('div', { className: 'stat-label' }, s.label),
        h('div', { className: 'stat-value' }, s.value),
        h('div', { className: 'stat-sub' }, s.sub)
      ))
    ),

    h('div', { className: 'section-title' }, 'In-Person Payment Rates (POS Card Readers)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Method'), h('th', null, 'Rate'), h('th', null, 'Status'))),
          h('tbody', null, ...([
            ['Card present (tap/chip/swipe)','2.3% + $0.10','Enabled'],
            ['Manual card entry','3.4% + $0.10','Enabled'],
            ['American Express','2.3% + $0.10','Enabled'],
            ['Apple Pay (NFC)','2.3% + $0.10','Enabled'],
            ['Google Pay (NFC)','2.3% + $0.10','Enabled'],
            ['Shop Pay','2.3% + $0.10','Enabled'],
            ['Shop Pay Installments','5.0% + $0.30','DISABLED'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className: 'mono', style: { fontSize:'13px' } }, r[1]),
            h('td', null, h('span', { className: 'badge ' + (r[2]==='Enabled'?'badge-green':'badge-high') }, r[2]))
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Online Payment Rates (Headless API + Online Store)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Method'), h('th', null, 'Domestic'), h('th', null, 'International'), h('th', null, 'Status'))),
          h('tbody', null, ...([
            ['Cards and wallets (Standard)','2.25% + $0.30','3.25% + $0.30','Enabled'],
            ['Cards and wallets (Premium)','2.95% + $0.30','3.95% + $0.30','Enabled'],
            ['American Express','2.95% + $0.30','3.95% + $0.30','Enabled'],
            ['PayPal Wallet','3.49% + $0.49','4.99% + $0.49','Enabled'],
            ['Shop Pay','2.25% + $0.30','3.25% + $0.30','Enabled'],
            ['Shop Pay Installments','5.0% + $0.30','â€”','DISABLED'],
            ['USDC (Crypto)','2.25% + $0.30','â€”','Disabled'],
            ['ACH Direct Debit (B2B)','1.0% + $0.00 (cap $7.50)','â€”','Enabled'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className: 'mono', style: { fontSize:'12px' } }, r[1]),
            h('td', { className: 'mono', style: { fontSize:'12px' } }, r[2]),
            h('td', null, h('span', { className: 'badge ' + (r[3]==='Enabled'?'badge-green':'badge-high') }, r[3]))
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Payment Methods Enabled by Channel'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Payment Method'), h('th', null, 'POS (In-Person)'), h('th', null, 'Online Store'), h('th', null, 'Headless API'))),
          h('tbody', null, ...([
            ['Visa','Yes','Yes','Yes'],
            ['Mastercard','Yes','Yes','Yes'],
            ['American Express','Yes','Yes','Yes'],
            ['Diners Club','Yes','Yes','Yes'],
            ['Discover','Yes','Yes','Yes'],
            ['Apple Pay','Yes (NFC)','Yes','Yes'],
            ['Google Pay','Yes (NFC)','Yes','Yes'],
            ['Shop Pay','Yes','Yes','Yes'],
            ['PayPal Wallet','No','Yes','Yes'],
            ['Amazon Pay','No','No','No'],
            ['ACH Direct Debit','No','Yes (B2B)','Yes (B2B)'],
            ['USDC Crypto','No','No','No'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            ...r.slice(1).map(c => {
              const isYes = c.startsWith('Yes');
              return h('td', { style: { color: isYes?'var(--green)':'var(--red)', fontWeight:'500' } }, (isYes?'âœ“ ':'âœ• ') + c);
            })
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Decisions and Notes'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Item'), h('th', null, 'Decision'), h('th', null, 'Reason'))),
          h('tbody', null, ...([
            ['Shop Pay Installments (POS)','Disabled','BNPL not appropriate for Unicity health products at POS without leadership approval'],
            ['Shop Pay Installments (Online)','Disabled','Same rationale as POS. Re-enable if leadership requests.'],
            ['Amazon Pay','Disabled (both)','Not supported on physical POS card readers. Not needed for pilot online.'],
            ['USDC Crypto','Disabled','Not needed for pilot. Can enable later if requested.'],
            ['ACH Direct Debit','Enabled (online B2B)','Useful for large B2B distributor orders. Lower rate (1% cap $7.50).'],
            ['PayPal Wallet','Enabled (online only)','Available for Headless checkout. Not available at POS hardware.'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', null, h('span', { className: 'badge ' + (r[1].startsWith('Disabled')?'badge-high':'badge-green') }, r[1])),
            h('td', { style: { fontSize:'12px', color:'var(--text-muted)' } }, r[2])
          ))))
        )
      )
    ),

    h('div', { className: 'info-box' },
      h('strong', null, 'Rate note: '), 'Shopify Plus rates are fixed by Shopify/Stripe. No interchange-plus pricing available. These rates apply to all transactions at the plan level. Premium card rates (2.95%) apply to cards like corporate and rewards cards with higher interchange.'
    ),

    // â”€â”€ Shopify Plus Plan Fees â”€â”€
    h('div', { className: 'section-title' }, 'Shopify Plus Plan Fees (from Settings > Plan)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Fee Type'), h('th', null, 'Amount'), h('th', null, 'Notes'))),
          h('tbody', null, ...([
            ['Fixed Platform Fee','$2,500 USD/month','1-year term, renews Jan 30, 2027'],
            ['Variable: Online transactions','0.40%','Applies above $625K/month threshold'],
            ['Variable: Retail (POS) transactions','0.25%','Applies above $625K/month threshold'],
            ['Variable: B2B transactions','0.18%','Applies above $625K/month threshold'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className: 'mono', style: { fontWeight:'600' } }, r[1]),
            h('td', { style: { fontSize:'12px', color:'var(--text-muted)' } }, r[2])
          ))))
        )
      )
    ),
    h('div', { className: 'info-box warn', style: { marginTop:'16px' } },
      h('strong', null, 'Variable platform fees: '), 'At the end of each billing cycle you pay whichever is greater: the $2,500 fixed fee OR the variable percentage of sales. Variable fees only kick in if monthly sales exceed roughly $625,000 (depending on revenue source split). For the pilot this will not apply.'
    ),

    // â”€â”€ Fee Layers Explained â”€â”€
    h('div', { className: 'section-title' }, 'Understanding the Fee Layers (They Stack)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Layer'), h('th', null, 'What It Is'), h('th', null, 'Paid To'), h('th', null, 'When It Applies'))),
          h('tbody', null, ...([
            ['1. Platform Fee','$2,500/mo or variable %','Shopify','Always (monthly subscription)'],
            ['2. Payment Processing','2.3% + $0.10 (POS) or 2.25% + $0.30 (online)','Shopify Payments (Stripe)','Every transaction through Shopify Payments'],
            ['3. Third-Party Surcharge','+ 0.20% per transaction','Shopify','ONLY if NOT using Shopify Payments as primary gateway'],
            ['4. International Surcharge','+ 1.0% on top of domestic rate','Shopify Payments','ONLY on cards issued outside US'],
            ['5. Currency Conversion','1.5% of converted amount','Shopify Payments','ONLY when payout currency differs from payment currency'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'600' } }, r[0]),
            h('td', { className: 'mono', style: { fontSize:'12px' } }, r[1]),
            h('td', null, r[2]),
            h('td', { style: { fontSize:'12px', color:'var(--text-muted)' } }, r[3])
          ))))
        )
      )
    ),

    // â”€â”€ Scenario Comparison â”€â”€
    h('div', { className: 'section-title' }, 'Scenario Comparison: What Changes by Setup'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Fee Component'),
            h('th', null, 'A: Standard Storefront + Shopify Payments'),
            h('th', null, 'B: Headless API + Shopify Payments (CURRENT)'),
            h('th', null, 'C: Any Storefront + Third-Party Gateway')
          )),
          h('tbody', null, ...([
            ['Platform fee', '$2,500/mo', '$2,500/mo', '$2,500/mo'],
            ['POS card present', '2.3% + $0.10', '2.3% + $0.10', 'Processor rate (varies)'],
            ['Online domestic', '2.25% + $0.30', '2.25% + $0.30', 'Processor rate (varies)'],
            ['Online premium cards', '2.95% + $0.30', '2.95% + $0.30', 'Processor rate (varies)'],
            ['Shopify surcharge', '0%', '0%', '+ 0.20% per transaction'],
            ['Variable platform (>$625K)', '0.25% POS / 0.40% online', '0.25% POS / 0.40% online', '0.25% POS / 0.40% online'],
            ['Third-party fees waived?', 'Yes (Plus + Shopify Payments)', 'Yes (Plus + Shopify Payments)', 'No, 0.20% on every sale'],
            ['PayPal surcharge', 'None (Plus waives)', 'None (Plus waives)', 'None (Plus waives)'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className: 'mono', style: { fontSize:'12px' } }, r[1]),
            h('td', { className: 'mono', style: { fontSize:'12px', background:'rgba(0,200,100,0.06)' } }, r[2]),
            h('td', { className: 'mono', style: { fontSize:'12px' } }, r[3])
          ))))
        )
      )
    ),
    h('div', { className: 'info-box success', style: { marginTop:'16px' } },
      h('strong', null, 'Key takeaway: '), 'Standard storefront and Headless API have identical payment rates. The storefront type (standard vs headless) does NOT change your Shopify Payments processing fees. Headless costs no extra for payments. Switching to a third-party gateway adds 0.20% to every transaction on top of whatever that processor charges.'
    ),

    // â”€â”€ Real Cost Examples â”€â”€
    h('div', { className: 'section-title' }, 'Real Cost Example: $100 POS Sale'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Cost Component'),
            h('th', null, 'Shopify Payments (Current)'),
            h('th', null, 'Third-Party (e.g. Stripe Direct)')
          )),
          h('tbody', null, ...([
            ['Processing fee', '$2.30 + $0.10 = $2.40', '~$2.90 + $0.30 = $3.20'],
            ['Shopify surcharge (0.20%)', '$0.00', '$0.20'],
            ['Total per-transaction cost', '$2.40 (2.40%)', '$3.40 (3.40%)'],
            ['Savings with Shopify Payments', 'â€”', '$1.00 more per $100 sale'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className: 'mono', style: { fontSize:'12px', color:'var(--green)' } }, r[1]),
            h('td', { className: 'mono', style: { fontSize:'12px', color:'var(--red)' } }, r[2])
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Real Cost Example: $100 Online Sale'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Cost Component'),
            h('th', null, 'Shopify Payments (Current)'),
            h('th', null, 'Third-Party (e.g. Authorize.net)')
          )),
          h('tbody', null, ...([
            ['Processing fee', '$2.25 + $0.30 = $2.55', '~$2.90 + $0.30 = $3.20'],
            ['Shopify surcharge (0.20%)', '$0.00', '$0.20'],
            ['Total per-transaction cost', '$2.55 (2.55%)', '$3.40 (3.40%)'],
            ['Savings with Shopify Payments', 'â€”', '$0.85 more per $100 sale'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className: 'mono', style: { fontSize:'12px', color:'var(--green)' } }, r[1]),
            h('td', { className: 'mono', style: { fontSize:'12px', color:'var(--red)' } }, r[2])
          ))))
        )
      )
    ),

    h('div', { className: 'info-box', style: { marginTop:'16px' } },
      h('strong', null, 'Volume impact: '), 'At $50K/month in POS sales, the difference between Shopify Payments ($1,200) and a third-party gateway (~$1,700) is roughly $500/month or $6,000/year. At $500K/month the gap grows to ~$5,000/month.'
    ),

    h('div', { className: 'info-box warn', style: { marginTop:'16px' } },
      h('strong', null, '3-year term option: '), 'Shopify suggests renewing on a 3-year term to save on the monthly platform fee. Current: $2,500/mo (1-year). Contact Shopify support for 3-year pricing. Renewal date: January 30, 2027.'
    )
  );
}

function renderDataFlow() {
  return h('div', null,
    h('div', { className: 'info-box success' },
      h('strong', null, 'Core Insight (Session 2): '),
      'Shopify does NOT need Unicity distributor IDs. Data flows one direction: Shopify captures orders and staff attribution, daily export enriches with distributor ID via lookup, Unity handles customer IDs, commissions, PV/BV, and fulfillment. Email is the join key. This eliminates the round-trip sync concern entirely.'
    ),

    h('div', { className: 'section-title' }, 'Two Sales Channels at Launch'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Channel'), h('th', null, 'How It Works'), h('th', null, 'Attribution'))),
          h('tbody', null,
            h('tr', null, h('td', { style: { fontWeight:'500' } }, 'POS Card Reader'), h('td', null, 'Distributor enters PIN, customer taps card'), h('td', null, 'Automatic via Shopify staff PIN')),
            h('tr', null, h('td', { style: { fontWeight:'500' } }, 'Unicity Retail Site'), h('td', null, 'Customer browses Colby\'s frontend, redirects to Shopify checkout'), h('td', null, 'None at checkout, email match post-sale'))
          )
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Customer Matching Scenarios'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Scenario'), h('th', null, 'Condition'), h('th', null, 'Action'), h('th', null, 'Count'))),
          h('tbody', null,
            h('tr', null,
              h('td', { style: { fontWeight:'600', color:'var(--green)' } }, 'A: Existing + Sponsor'),
              h('td', null, 'Email match in Unity, sponsor assigned'),
              h('td', null, 'Auto-import, sponsor gets commission. No manual work.'),
              h('td', null, h('span', { className: 'badge badge-green' }, '711 preloaded'))
            ),
            h('tr', null,
              h('td', { style: { fontWeight:'600', color:'var(--yellow)' } }, 'B: Existing Orphan'),
              h('td', null, 'Email match in Unity, no sponsor'),
              h('td', null, 'Flag for CSR orphan queue. Same process as today.'),
              h('td', null, h('span', { className: 'badge badge-normal' }, 'Edge case'))
            ),
            h('tr', null,
              h('td', { style: { fontWeight:'600', color:'var(--red)' } }, 'C: New Customer'),
              h('td', null, 'No email match in Unity'),
              h('td', null, 'POS: distributor becomes sponsor. Retail: orphan tree (ID=2).'),
              h('td', null, h('span', { className: 'badge badge-high' }, 'New sales'))
            )
          )
        ),
        h('div', { className: 'info-box', style: { marginTop:'12px', marginBottom:'0' } },
          h('strong', null, 'Why preload matters: '), '711 MS customers were bulk-imported before launch (Session 3). When a distributor processes a POS sale and the customer\'s email matches a preloaded record, it resolves as Scenario A (automatic commission) instead of Scenario C (orphan tree). This is the primary value of the import.'
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Customer Import Status (Session 3)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Metric'), h('th', null, 'Value'))),
          h('tbody', null, ...([
            ['CSV rows submitted', '729'],
            ['Successfully imported', '711'],
            ['Duplicates skipped', '18 (email already in store)'],
            ['Failed', '0'],
            ['Metafields validated', 'All 4 populated (spot-checked Florine Bennett, ID 271117101)'],
          ].map(r => h('tr', null, h('td', { style: { fontWeight:'500' } }, r[0]), h('td', null, r[1])))))
        ),
        h('div', { style: { marginTop:'12px' } },
          h('table', null,
            h('thead', null, h('tr', null, h('th', null, 'Metafield'), h('th', null, 'Namespace.Key'), h('th', null, 'Type'))),
            h('tbody', null, ...([
              ['unicity_id', 'custom.unicity_id', 'Single line text'],
              ['unicity_customer_status', 'custom.unicity_customer_status', 'Single line text'],
              ['existing_subscription', 'custom.existing_subscription', 'True or false'],
              ['origin', 'custom.origin', 'Single line text'],
            ].map(r => h('tr', null, ...r.map((c,i) => h('td', i===1 ? { className:'mono', style:{fontSize:'12px'} } : null, c))))))
          )
        ),
        h('div', { className: 'info-box', style: { marginTop:'12px', marginBottom:'0' } },
          h('strong', null, 'Namespace note: '), 'NZL store uses account_info namespace (API-created). US store uses custom namespace (Admin UI limitation). CSV headers must use customer.metafields.custom.* format.'
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Product Catalog (Session 3)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Product'), h('th', null, 'SKU'), h('th', null, 'Wholesale (Price)'), h('th', null, 'Retail (Compare at)'), h('th', null, 'Discount'))),
          h('tbody', null, ...([
            ['Balance Natural Orange', '35830', '$49.00', '$79.00', '38%'],
            ['Balance Mixed Berry', '35932', '$49.00', '$79.00', '38%'],
            ['Diamond Bottle 500ml', '32015', '$8.00', '$12.00', '33%'],
            ['Unimate Lemon Ginger', '35290', '$79.00', '$115.00', '31%'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className:'mono', style:{fontSize:'12px'} }, r[1]),
            h('td', { style: { color:'var(--green)' } }, r[2]),
            h('td', { style: { color:'var(--text-muted)' } }, r[3]),
            h('td', null, r[4])
          ))))
        ),
        h('div', { style: { marginTop:'12px' } },
          h('table', null,
            h('thead', null, h('tr', null, h('th', null, 'Customer Status'), h('th', null, 'Price Tier'), h('th', null, 'Count'), h('th', null, 'Coverage'))),
            h('tbody', null,
              h('tr', null, h('td', null, 'A/M/H (Wholesale)'), h('td', null, 'Price field = wholesale'), h('td', null, '720'), h('td', null, h('span', { className: 'badge badge-green' }, '98%'))),
              h('tr', null, h('td', null, 'C (Retail)'), h('td', null, 'Compare at field = retail'), h('td', null, '9'), h('td', null, h('span', { className: 'badge badge-high' }, 'Needs fix')))
            )
          )
        ),
        h('div', { className: 'info-box warn', style: { marginTop:'12px', marginBottom:'0' } },
          h('strong', null, 'Retail gap: '), '9 status-C customers see wholesale price by default. Future fix: Shopify Functions or manual POS override at checkout.'
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Order Data Flow'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('div', { className: 'flow' },
          ...([
            { icon:'ðŸ’³', bg:'var(--accent-glow)', title:'Customer Pays', sub:'Card reader / Tap' },
            { icon:'ðŸ“', bg:'var(--green-bg)', title:'Order Created', sub:'staff_id attributed' },
            { icon:'ðŸ“¤', bg:'var(--yellow-bg)', title:'CSV Export', sub:'Daily from Admin' },
            { icon:'ðŸ”„', bg:'var(--purple-bg)', title:'Map Staff â†’ ID', sub:'Lookup table' },
            { icon:'ðŸ“¥', bg:'var(--green-bg)', title:'Import to Unity', sub:'Batch import' },
            { icon:'ðŸ’°', bg:'var(--accent-glow)', title:'Commissions', sub:'InfoTrax pipeline' },
          ].map(s => h('div', { className: 'flow-step' },
            h('div', { className: 'flow-icon', style: { background: s.bg } }, s.icon),
            h('div', { className: 'flow-title' }, s.title),
            h('div', { className: 'flow-sub' }, s.sub)
          )))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'POS Order Flow (Card Reader)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Step'), h('th', null, 'Action'), h('th', null, 'Who'))),
          h('tbody', null, ...([
            ['1','Open Shopify POS app on iPhone','Distributor'],
            ['2','Enter unique 4-6 digit PIN','Distributor (auto-assigns staff_id)'],
            ['3','Browse product catalog, add items to cart','Distributor'],
            ['4','Customer taps or inserts card on reader','Customer'],
            ['5','Shopify Payments captures payment immediately','Shopify (auto-capture)'],
            ['6','Order created with source_name="pos", staff attribution','Shopify'],
            ['7','Order visible in Admin with "Attributed to" field','Shopify Admin'],
            ['8','Daily CSV export captures order with staff name','HQ Admin (manual)'],
            ['9','Map staff name to Unicity distributor ID','Lookup table'],
            ['10','Import to Unity database','Data team'],
          ].map(r => h('tr', null, ...r.map((c,i) => h('td', i===0 ? { className:'mono', style:{color:'var(--accent)',fontWeight:'600'} } : null, c))))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Subscription / Autoship Flow'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('div', { className: 'flow' },
          ...([
            { icon:'ðŸ›’', bg:'var(--accent-glow)', title:'Customer Selects', sub:'Subscription plan' },
            { icon:'ðŸ’³', bg:'var(--green-bg)', title:'Initial Charge', sub:'Card token vaulted' },
            { icon:'ðŸ“…', bg:'var(--yellow-bg)', title:'Billing Schedule', sub:'App creates order' },
            { icon:'âš¡', bg:'var(--purple-bg)', title:'Auto-Charge', sub:'Vaulted payment' },
            { icon:'ðŸ“¤', bg:'var(--green-bg)', title:'CSV Export', sub:'Renewal order' },
            { icon:'ðŸ“¥', bg:'var(--accent-glow)', title:'Unity Import', sub:'Data team' },
          ].map(s => h('div', { className: 'flow-step' },
            h('div', { className: 'flow-icon', style: { background: s.bg } }, s.icon),
            h('div', { className: 'flow-title' }, s.title),
            h('div', { className: 'flow-sub' }, s.sub)
          )))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'CSV Export: Field Mapping'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Shopify CSV Field'), h('th', null, 'Unity DB Field'), h('th', null, 'Notes'))),
          h('tbody', null, ...([
            ['Name (order number)','ORDER_NUMBER','Shopify format: #1001, #1002'],
            ['Created at','ORDER_DATE','ISO 8601 format'],
            ['Total','ORDER_TOTAL','Decimal, includes tax'],
            ['Subtotal','SUBTOTAL','Before tax/shipping'],
            ['Financial Status','PAYMENT_STATUS','paid / refunded / partially_refunded'],
            ['Attributed staff','DIST_ID (via mapping)','Staff display name â†’ Unicity ID'],
            ['Source','ORDER_SOURCE','"pos" / "web" / subscription app'],
            ['Lineitem name','PRODUCT_NAME','Product sold'],
            ['Lineitem sku','SKU','For PV/BV lookup in Unity'],
            ['Lineitem quantity','QTY','Units sold'],
            ['Lineitem price','UNIT_PRICE','Per-unit price'],
            ['Selling Plan Name','SUBSCRIPTION_FLAG','Present if subscription'],
            ['Billing Name','CUSTOMER_NAME','Customer who purchased'],
            ['Email','CUSTOMER_EMAIL','For subscription customers'],
          ].map(r => h('tr', null, ...r.map((c,i) => h('td', i===0 ? { className:'mono', style:{fontSize:'12px'} } : null, c))))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Daily CSV Export Process'),
    h('div', { className: 'info-box' }, h('strong', null, 'Estimated daily effort: '), '15-30 minutes for 10 distributors'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, '#'), h('th', null, 'Action'), h('th', null, 'Owner'), h('th', null, 'Time'))),
          h('tbody', null, ...([
            ['1','Go to Shopify Admin â†’ Orders','Howard or delegate',''],
            ['2','Filter by date range (previous day)','',''],
            ['3','Filter by location: US-Pilot','',''],
            ['4','Click Export â†’ Export orders â†’ CSV for Excel','',''],
            ['5','Add Unicity Distributor ID column using staff name mapping','','5 min'],
            ['6','Validate: order count matches Shopify dashboard','','2 min'],
            ['7','Send to data team for Unity import','Bryan Simmons',''],
            ['8','Verify imported orders in Unity','','5 min'],
          ].map(r => h('tr', null, ...r.map((c,i) => h('td', i===0 ? { className:'mono', style:{color:'var(--accent)'} } : null, c))))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Automation Path (Phased, Session 2)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Phase'), h('th', null, 'Timeline'), h('th', null, 'Approach'), h('th', null, 'Effort'))),
          h('tbody', null, ...([
            ['Launch (Feb 21)', 'Week 1', 'Manual CSV + staff name lookup (10 rows)', '15 min/day'],
            ['Post-launch', 'Mar 3-7', 'Google Apps Script webhook receiver (no code)', '1-2 day setup'],
            ['Scale-up', 'Month 2+', 'Node.js sync service on Replit with HMAC verification', '3-5 dev days'],
            ['500+ distributors', 'If needed', 'Full middleware (original Ticket 10 scope)', '2-3 weeks'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { style: { fontSize:'12px', color:'var(--text-muted)' } }, r[1]),
            h('td', null, r[2]),
            h('td', null, r[3])
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Distributor Mapping Strategy'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Phase'), h('th', null, 'Method'), h('th', null, 'Status'))),
          h('tbody', null, ...([
            ['Launch', 'Option 2: Staff name lookup table (VLOOKUP or SQL, 10 rows)', 'Active'],
            ['Week 2', 'Option 3: Shopify Flow + Google Sheets (no code)', 'Planned'],
            ['Month 2+', 'Option 4: Admin API scheduled pull (developer builds)', 'Future'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', null, r[1]),
            h('td', null, h('span', { className: 'badge ' + (r[2]==='Active'?'badge-green':r[2]==='Planned'?'badge-normal':'') }, r[2]))
          ))))
        ),
        h('div', { className: 'info-box', style: { marginTop:'12px', marginBottom:'0' } },
          h('strong', null, 'Note: '), 'Option 1 (customer tags as distributor store) was evaluated and rejected. Distributors sell TO customers, not as customers.'
        )
      )
    )
  );
}

function renderPermissions() {
  // â”€â”€ Helper: permission table with color-coded cells â”€â”€
  function permTable(title, headers, data) {
    return h('div', null,
      h('div', { className: 'section-title' }, title),
      h('div', { className: 'card' },
        h('div', { className: 'card-body', style: { paddingTop:'16px' } },
          h('table', null,
            h('thead', null, h('tr', null,
              ...headers.map(hdr => h('th', null, hdr))
            )),
            h('tbody', null, ...data.map(r => h('tr', null,
              h('td', { style: { fontWeight:'500' } }, r[0]),
              ...r.slice(1).map(c => {
                const s = String(c);
                const isYes = s === 'Allowed' || s.startsWith('Yes') || s === 'âœ“';
                const isNo = s === 'Denied' || s === 'No' || s.startsWith('NO') || s === 'âœ•';
                const isOn = s === 'ON';
                const isOff = s === 'OFF';
                return h('td', { style: { color: (isYes||isOn)?'var(--green)':(isNo||isOff)?'var(--red)':'var(--text)', fontWeight:'500' } },
                  (isYes ? 'âœ“ ' : isNo ? 'âœ• ' : isOn ? 'â— ' : isOff ? 'â—‹ ' : '') + s
                );
              })
            )))
          )
        )
      )
    );
  }

  // â”€â”€ 1. API Credentials â”€â”€
  const apiCreds = [
    ['App Name', 'KnockBase'],
    ['Created Via', 'Shopify Dev Dashboard (new flow, not legacy custom app)'],
    ['Store Domain', 'unicity-international-2.myshopify.com'],
    ['Client ID (public token)', 'd2c0ef567f998839295caad508319d35'],
    ['Storefront Access Token', 'Not applicable (Plus Dev Dashboard uses Client ID as public token)'],
    ['Storefront API Endpoint', 'https://unicity-international-2.myshopify.com/api/2024-10/graphql.json'],
    ['Sent To', 'Colby Cook (Ticket #21, completed Feb 14)'],
  ];

  // â”€â”€ 2. Storefront API Permissions (from Shopify settings screenshot) â”€â”€
  const sfPerms = [
    ['Products', 'unauthenticated_read_product_listings', 'Read products, variants, collections', 'ON'],
    ['Products', 'unauthenticated_read_product_tags', 'Read product tags', 'ON'],
    ['Products', 'unauthenticated_read_product_inventory', 'Read inventory of products/variants', 'OFF'],
    ['Products', 'unauthenticated_read_product_pickup_locations', 'Read in-store pickup availability', 'OFF'],
    ['Customers', 'unauthenticated_read_customers', 'Read customer details', 'OFF'],
    ['Customers', 'unauthenticated_write_customers', 'Modify customer details', 'OFF'],
    ['Customers', 'unauthenticated_read_customer_tags', 'Read customer tags', 'OFF'],
    ['Content', 'unauthenticated_read_content', 'Read articles, blogs, comments', 'OFF'],
    ['Checkout', 'unauthenticated_read_checkouts', 'Read checkouts', 'ON'],
    ['Checkout', 'unauthenticated_write_checkouts', 'Modify checkouts', 'ON'],
    ['Selling plans', 'unauthenticated_read_selling_plans', 'Read selling plans', 'ON'],
    ['Bulk operations', 'unauthenticated_read_bulk_operations', 'Read bulk operations', 'OFF'],
    ['Bulk operations', 'unauthenticated_write_bulk_operations', 'Write bulk operations', 'OFF'],
    ['Product bundles', 'unauthenticated_read_bundles', 'Read product bundles', 'OFF'],
    ['Shop Pay', 'unauthenticated_read_shop_pay_installments_pricing', 'Read installments pricing', 'OFF'],
    ['Metaobjects', 'unauthenticated_read_metaobjects', 'Read metaobjects', 'OFF'],
  ];

  // â”€â”€ 3. POS Roles Summary â”€â”€
  const posRoles = [
    ['Associate', 'Default', '13 of 42', '0 staff'],
    ['Full permissions', '', '42 of 42', '3 staff'],
    ['Limited permissions', '', '13 of 42', '0 staff'],
    ['Manager', 'Regional Mgr', '25 of 42', '0 staff'],
    ['Sales', 'Distributor', '5 of 42', '0 staff'],
  ];

  // â”€â”€ 4. Detailed POS Role Permissions: Manager vs Sales (Distributor) â”€â”€
  // From actual Shopify screenshots Feb 14, 2026
  const posDetailPerms = [
    // [Category, Permission, Manager, Sales(Distributor)]
    ['Checkout', 'Manager approval', 'Denied', 'Denied'],
    ['Checkout', 'Add custom sales', 'Allowed', 'Allowed'],
    ['Checkout', 'Ship to customer', 'Allowed', 'Denied'],
    ['Checkout', 'Edit taxes', 'Allowed', 'Denied'],
    ['Checkout', 'Accept offline credit/debit', 'Disabled', 'Disabled'],
    ['Discounts', 'Apply custom discounts', 'Allowed', 'Denied'],
    ['Discounts', 'Apply discount codes', 'Allowed', 'Allowed'],
    ['Orders', 'Manage orders at all locations', 'Allowed', 'Denied'],
    ['Orders', 'Manage sales attribution', 'Allowed', 'Allowed'],
    ['Orders', 'Return and exchange orders', 'Allowed', 'Denied'],
    ['Orders', 'Return ineligible items', 'Allowed', 'Denied'],
    ['Orders', 'Create unverified returns', 'Allowed', 'Denied'],
    ['Orders', 'Cancel orders', 'Allowed', 'Allowed'],
    ['Orders', 'Manage draft orders (all loc)', 'Denied', 'Denied'],
    ['Orders', 'Fulfill shipping orders', 'Denied', 'Denied'],
    ['Orders', 'Reassign/cancel fulfillment', 'Denied', 'Denied'],
    ['Customers', 'Edit customer details', 'Allowed', 'Denied'],
    ['Customers', 'View metafields', 'Allowed', 'Denied'],
    ['Customers', 'Edit metafields', 'Allowed', 'Denied'],
    ['Customers', 'Create new customers', 'Allowed', 'Denied'],
    ['Customers', 'Delete customers', 'Allowed', 'Denied'],
    ['Customers', 'Manage store credit', 'Allowed', 'Denied'],
    ['Customers', 'Redeem store credit', 'Allowed', 'Denied'],
    ['Inventory', 'Manage transfers', 'Denied', 'Denied'],
    ['Apps', 'Use apps with Shopify POS', 'Denied', 'Denied'],
    ['Apps', 'Manage POS UI extensions', 'Denied', 'Denied'],
    ['Analytics', 'View analytics (device loc)', 'Allowed', 'Denied'],
    ['Register', 'Manage payment tracking', 'Denied', 'Denied'],
    ['Register', 'Open drawer', 'Denied', 'Denied'],
    ['Staff', 'Manage POS staff', 'Allowed', 'Denied'],
    ['Staff', 'Manage POS roles', 'Allowed', 'Denied'],
    ['Settings', 'Customize smart grid', 'Allowed', 'Denied'],
    ['Settings', 'Manage payment settings', 'Denied', 'Denied'],
    ['Settings', 'Manage offline payments', 'Denied', 'Denied'],
    ['Settings', 'Manage receipt settings', 'Denied', 'Denied'],
    ['Settings', 'Manage required checkout info', 'Denied', 'Denied'],
    ['Settings', 'Switch device location', 'Denied', 'Denied'],
    ['Settings', 'Log out from POS app', 'Allowed', 'Allowed'],
  ];

  // â”€â”€ 5. Store-Level Permissions (Web Admin) â”€â”€
  const storePerms = [
    ['Access Shopify Admin','No','Yes (limited)','Yes (full)'],
    ['Products: View','No','Yes','Yes'],
    ['Products: Edit','No','Yes (availability)','Yes'],
    ['Products: Change pricing','No','NO (policy)','Yes'],
    ['Customers: View','No','Yes','Yes'],
    ['Customers: Edit','No','Yes','Yes'],
    ['Orders: View','No','Yes (own location)','Yes'],
    ['Orders: Export CSV','No','No','Yes (HQ only)'],
    ['Analytics / Reports','No','No','Yes'],
    ['Finances / Payouts','No','No','Yes'],
    ['Settings / Payment config','No','No','Yes'],
    ['Users / Permissions','No','No','Yes'],
  ];

  // â”€â”€ Build the page â”€â”€
  return h('div', null,

    // API Credentials Card
    h('div', { className: 'section-title' }, 'Headless API Credentials (KnockBase App)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('tbody', null, ...apiCreds.map(r => h('tr', null,
            h('td', { style: { fontWeight:'600', width:'260px', whiteSpace:'nowrap' } }, r[0]),
            h('td', { style: { fontFamily: r[0].includes('Client ID') || r[0].includes('Endpoint') || r[0].includes('Domain') ? 'monospace' : 'inherit', fontSize: r[0].includes('Client ID') || r[0].includes('Endpoint') ? '12px' : '13px', wordBreak:'break-all' } }, r[1])
          )))
        )
      )
    ),
    h('div', { className: 'info-box', style: { marginTop:'16px' } },
      h('strong', null, 'Shopify Plus Dev Dashboard: '), 'No separate Storefront Access Token. The Client ID serves as the public token for unauthenticated Storefront API requests. Pass it as the X-Shopify-Storefront-Access-Token header.'
    ),

    // Storefront API Permissions
    h('div', { className: 'section-title' }, 'Storefront API Permissions'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Category'),
            h('th', null, 'Scope'),
            h('th', null, 'Description'),
            h('th', null, 'Status')
          )),
          h('tbody', null, ...sfPerms.map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { style: { fontFamily:'monospace', fontSize:'11px' } }, r[1]),
            h('td', null, r[2]),
            h('td', { style: { color: r[3]==='ON'?'var(--green)':'var(--red)', fontWeight:'600' } },
              (r[3]==='ON' ? 'â— ' : 'â—‹ ') + r[3])
          )))
        )
      )
    ),
    h('div', { className: 'info-box warn', style: { marginTop:'16px' } },
      h('strong', null, 'Shared across all Headless storefronts. '), 'These permissions apply to every Headless channel. Customer read/write left OFF for now. Enable if Colby needs customer lookup in the headless checkout.'
    ),

    // POS Roles Summary
    h('div', { className: 'section-title' }, 'POS Roles Summary (5 roles configured)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Role'),
            h('th', null, 'Pilot Mapping'),
            h('th', null, 'Permissions'),
            h('th', null, 'Staff Assigned')
          )),
          h('tbody', null, ...posRoles.map(r => h('tr', null,
            h('td', { style: { fontWeight:'600' } }, r[0]),
            h('td', { style: { color: r[1] ? 'var(--accent)' : 'var(--muted)', fontStyle: r[1]?'normal':'italic' } }, r[1] || 'Not used in pilot'),
            h('td', null, r[2]),
            h('td', { style: { fontWeight:'500' } }, r[3])
          )))
        )
      )
    ),

    // Detailed POS Permissions: Manager vs Sales
    h('div', { className: 'section-title' }, 'POS Role Permissions Detail: Manager vs Sales (Distributor)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, 'Category'),
            h('th', null, 'Permission'),
            h('th', null, 'Manager (25/42)'),
            h('th', null, 'Sales / Distributor (5/42)')
          )),
          h('tbody', null, ...posDetailPerms.map((r, i) => {
            const prevCat = i > 0 ? posDetailPerms[i-1][0] : '';
            const showCat = r[0] !== prevCat;
            return h('tr', null,
              h('td', { style: { fontWeight: showCat?'600':'400', color: showCat?'var(--text)':'var(--muted)', borderTop: showCat && i>0 ? '2px solid var(--border)' : 'none' } }, showCat ? r[0] : ''),
              h('td', { style: { fontWeight:'500', borderTop: showCat && i>0 ? '2px solid var(--border)' : 'none' } }, r[1]),
              ...[r[2], r[3]].map(c => {
                const isA = c === 'Allowed';
                const isD = c === 'Denied';
                const isDis = c === 'Disabled';
                return h('td', { style: { color: isA?'var(--green)':isD?'var(--red)':isDis?'var(--muted)':'var(--text)', fontWeight:'500', borderTop: showCat && i>0 ? '2px solid var(--border)' : 'none' } },
                  (isA ? 'âœ“ ' : isD ? 'âœ• ' : 'â—Œ ') + c);
              })
            );
          }))
        )
      )
    ),
    h('div', { className: 'info-box', style: { marginTop:'16px' } },
      h('strong', null, 'Key difference: '), 'Sales (Distributor) can only process sales, apply discount codes, manage their own sales attribution, cancel orders, and log out. Manager adds full customer management, returns, analytics, staff management, and custom discounts.'
    ),

    // Store-Level Permissions
    permTable('Store-Level Permissions (Web Admin)', ['Permission','Distributor','Regional Manager','HQ Admin'], storePerms),
    h('div', { className: 'info-box warn', style: { marginTop:'16px' } },
      h('strong', null, 'Pricing constraint: '), 'Product prices are store-wide in Shopify. If a regional manager edits a price, it affects every location. Enforce by policy that pricing changes go through HQ only.'
    ),

    // What the Distributor Sees
    h('div', { className: 'section-title' }, 'What the Distributor Sees'),
    h('div', { style: { display:'grid', gridTemplateColumns:'1fr 1fr', gap:'16px' } },
      h('div', { className: 'card' },
        h('div', { className: 'card-header' }, h('h3', null, 'âœ“ CAN Do (5 of 42 POS permissions)')),
        h('div', { className: 'card-body' },
          ...['Process sales (add custom sales)','Accept card payments (tap/chip/swipe)','Apply discount codes (pre-set only)','Manage their own sales attribution','Cancel orders','Log out from POS app'].map(t =>
            h('div', { style: { padding:'6px 0', fontSize:'13px', color:'var(--green)' } }, 'âœ“ ' + t)
          )
        )
      ),
      h('div', { className: 'card' },
        h('div', { className: 'card-header' }, h('h3', null, 'âœ• CANNOT Do')),
        h('div', { className: 'card-body' },
          ...['Apply custom discounts (manager only)','Process returns or exchanges','Edit customer details or create customers','View analytics or sales reports','Manage POS staff or roles','Change payment or receipt settings','Ship to customer','Edit taxes','Switch device location','Access Shopify admin','See other distributors\' sales','See financial settings or payouts'].map(t =>
            h('div', { style: { padding:'6px 0', fontSize:'13px', color:'var(--red)' } }, 'âœ• ' + t)
          )
        )
      )
    )
  );
}

function renderTickets() {
  const activeTickets = tickets.filter(t => t.phase !== 'X');
  const descopedTickets = tickets.filter(t => t.phase === 'X');

  function phaseLabel(p) {
    if (p === 1) return ['Phase 1: Shopify Setup', 'var(--accent)'];
    if (p === 2) return ['Phase 2: Configuration', 'var(--purple)'];
    if (p === 3) return ['Phase 3: Validation & Launch', 'var(--green)'];
    return ['Descoped', 'var(--text-dim)'];
  }

  return h('div', null,
    h('div', { className: 'info-box' },
      h('strong', null, 'Epic: '), 'Shopify POS Distributor Pilot â€” USA  |  23 active tickets, 2 descoped  |  ',
      h('a', { href:'https://app.clickup.com/t/86dztj228', target:'_blank', style: { color:'var(--accent)' } }, 'Open in ClickUp')
    ),

    ...[1,2,3].map(phase => {
      const pts = activeTickets.filter(t => t.phase === phase);
      const [label, color] = phaseLabel(phase);
      return h('div', null,
        h('div', { className: 'section-title', style: { color } }, label),
        h('div', { className: 'card' },
          h('div', { className: 'card-body', style: { paddingTop:'16px' } },
            h('table', null,
              h('thead', null, h('tr', null,
                h('th', { style: { width:'40px' } }, ''), h('th', { style: { width:'40px' } }, '#'), h('th', null, 'Ticket'), h('th', null, 'Priority'), h('th', null, 'Dependencies'), h('th', null, 'Effort')
              )),
              h('tbody', null, ...pts.map(t => h('tr', null,
                h('td', null,
                  h('div', { className: 'check-box' + (isChecked('tkt'+t.n)?' checked':''), onClick: () => toggleCheck('tkt'+t.n), style: { width:'16px', height:'16px', minWidth:'16px' } })
                ),
                h('td', { className: 'mono', style: { color:'var(--accent)' } }, '' + t.n),
                h('td', null,
                  h('a', { href: 'https://app.clickup.com/t/' + t.link, target:'_blank', style: { color: isChecked('tkt'+t.n)?'var(--text-dim)':'var(--text)', textDecoration: isChecked('tkt'+t.n)?'line-through':'none' } }, t.name)
                ),
                h('td', null, h('span', { className: 'badge ' + (t.pri==='High'?'badge-high':'badge-normal') }, t.pri)),
                h('td', { style: { fontSize:'12px', color:'var(--text-muted)' } }, t.dep),
                h('td', { className: 'mono', style: { fontSize:'12px' } }, t.effort)
              )))
            )
          )
        )
      );
    }),

    h('div', { className: 'section-title', style: { color:'var(--text-dim)' } }, 'Descoped'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        ...descopedTickets.map(t =>
          h('div', { style: { padding:'8px 0', display:'flex', gap:'12px', alignItems:'center', textDecoration:'line-through', color:'var(--text-dim)' } },
            h('span', { className: 'badge badge-descoped' }, 'DESCOPED'),
            h('span', null, `#${t.n} ${t.name}`)
          )
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Dependency Map'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Ticket'), h('th', null, 'Depends On'), h('th', null, 'Blocks'))),
          h('tbody', null, ...([
            ['1. Create Location','Plus plan active','2, 6, 7'],
            ['2. Activate POS Pro','1','3, 9'],
            ['3. Create POS Roles','2','5, 6'],
            ['4. Create Store Role','None','5'],
            ['5. Add Manager','3, 4','16'],
            ['6. Onboard Distributors','1, 3','9, 13, 18, 19'],
            ['7. Configure Products','1','14'],
            ['8. Verify Shopify Payments','Plus plan active','12, 18'],
            ['9. Configure Attribution','2, 6','19'],
            ['12. Configure Subscriptions','8','14'],
            ['13. Data Isolation','6','14'],
            ['14. E2E Testing','All previous','17'],
            ['15. Reconciliation Setup','9, 19','17'],
            ['16. Training Materials','5, 6','17'],
            ['17. Go-Live Checklist','All previous','Launch'],
            ['18. Card Readers','6, 8','14, 17'],
            ['19. CSV Export + Unity','6, 9','14, 15'],
            ['25. Customer Import','1','14'],
            ['26. Sync Automation','19','Post-launch (Mar 7)'],
          ].map(r => h('tr', null, ...r.map((c,i) => h('td', i===0 ? { style:{fontWeight:'500'} } : { style: { fontSize:'12px', color:'var(--text-muted)' } }, c))))))
        )
      )
    ),

    h('div', { className: 'info-box success' },
      h('strong', null, 'Critical Path: '), '1 â†’ 2 â†’ 3 â†’ 6 â†’ 9 â†’ 19 â†’ 14 â†’ 17  |  Middleware removal cut 3 weeks off the timeline.'
    )
  );
}

function renderSprint() {
  const days = [
    { day: 'Feb 14 (Sat) âœ“', done: true, tasks: [
      { t: '#1 Create Location âœ“', done: true },
      { t: '#2 Activate POS Pro âœ“', done: true },
      { t: '#8 Verify Payments âœ“', done: true },
      { t: '#20 Headless Channel âœ“', done: true },
      { t: '#21 Credentials to Colby âœ“', done: true },
      { t: '#22 Team Alignment âœ“', done: true },
    ]},
    { day: 'Feb 15 (Sun) âœ“', done: true, tasks: [
      { t: '#3 Create POS Roles âœ“', done: true },
      { t: '#7 Load 4 Products âœ“', done: true },
      { t: '#25 Import 711 Customers âœ“', done: true },
      { t: 'Order flow architecture âœ“', done: true },
      { t: 'Sync automation spec âœ“', done: true },
      { t: 'Dashboard + docs âœ“', done: true },
    ]},
    { day: 'Feb 17 (Mon)', tasks: [
      { t: '#4 Store Role for Manager' },
      { t: '#5 Add Regional Manager', crit: true },
      { t: 'Fix metafield type (IDâ†’Integer)', crit: true },
      { t: 'Populate distributor mapping table' },
    ]},
    { day: 'Feb 18 (Tue)', tasks: [
      { t: '#6 Onboard 10 Distributors', crit: true },
      { t: '#18 Pair Card Readers' },
      { t: '#9 Configure Attribution' },
    ]},
    { day: 'Feb 19 (Wed)', tasks: [
      { t: '#12 Configure Subscriptions' },
      { t: '#19 CSV Export Process' },
      { t: '#13 Data Isolation Validation' },
      { t: 'Remove password protection' },
    ]},
    { day: 'Feb 20 (Thu)', tasks: [
      { t: '#14 End-to-End Testing', crit: true },
      { t: '#15 Reconciliation Setup' },
      { t: '#16 Training Materials' },
    ]},
    { day: 'Feb 21 (Fri)', tasks: [
      { t: '#17 Go-Live Checklist', crit: true },
      { t: 'Stakeholder Sign-off' },
      { t: 'PILOT LIVE', crit: true },
    ]},
  ];

  return h('div', null,
    h('div', { className: 'info-box success' },
      h('strong', null, 'Sessions 1-3 completed Feb 14-15 (weekend). '), '9 of 23 tickets done. Critical path: onboard distributors (Feb 18) and E2E testing (Feb 20). Manager invite (Ticket #5) has a 7-day acceptance window but work continues in parallel.'
    ),
    h('div', { className: 'section-title' }, 'Sprint Timeline (Feb 14-21)'),
    h('div', { style: { borderRadius:'8px', overflow:'hidden', border:'1px solid var(--border)' } },
      ...days.map((d, i) => h('div', { className: 'sprint-day', style: { borderBottom: i < days.length-1 ? '1px solid var(--border)' : 'none', opacity: d.done ? 0.8 : 1 } },
        h('div', { className: 'sprint-day-label' + (d.done ? ' done' : '') }, d.day),
        h('div', { className: 'sprint-day-tasks' },
          ...d.tasks.map(t => h('span', { className: 'sprint-task' + (t.crit ? ' crit' : '') + (t.done ? ' done' : '') }, t.t))
        )
      ))
    ),

    h('div', { className: 'section-title' }, 'Phase Breakdown'),
    h('div', { className: 'timeline' },
      h('div', { className: 'tl-item done' },
        h('div', { className: 'tl-phase' }, 'Phase 1: Shopify Setup'),
        h('div', { className: 'tl-title' }, 'Feb 14-18: Tickets 1-8, 18, 20-23, 25'),
        h('div', { className: 'tl-detail' }, '12 of 14 done. Remaining: #6 Distributors, #18 Card Readers.')
      ),
      h('div', { className: 'tl-item' },
        h('div', { className: 'tl-phase' }, 'Phase 2: Configuration'),
        h('div', { className: 'tl-title' }, 'Feb 18-19: Tickets 9, 12, 19, 26'),
        h('div', { className: 'tl-detail' }, '1 of 4 done (#19 CSV Export). Remaining: Attribution, subscriptions. Sync automation (Ticket 26) due Mar 7.')
      ),
      h('div', { className: 'tl-item' },
        h('div', { className: 'tl-phase' }, 'Phase 3: Validation & Launch'),
        h('div', { className: 'tl-title' }, 'Feb 20-21: Tickets 13-17'),
        h('div', { className: 'tl-detail' }, 'E2E tests, training, go-live checklist.')
      )
    ),

    h('div', { className: 'section-title' }, 'Timeline Comparison'),
    h('div', { className: 'cost-compare' },
      h('div', { className: 'cost-bar-container' },
        h('div', { className: 'cost-bar-label' }, 'Original (middleware + commission engine)'),
        h('div', { className: 'cost-bar-wrap' },
          h('div', { className: 'cost-bar-fill', style: { width:'100%', background:'var(--red)' } }, '6 weeks')
        )
      ),
      h('div', { className: 'cost-bar-container' },
        h('div', { className: 'cost-bar-label' }, 'Current (CSV export, no middleware)'),
        h('div', { className: 'cost-bar-wrap' },
          h('div', { className: 'cost-bar-fill', style: { width:'17%', background:'var(--green)' } }, '~1 week')
        )
      )
    )
  );
}

function renderHardware() {
  return h('div', null,
    h('div', { className: 'stats' },
      ...[
        { label:'Device', value:'Tap & Chip', sub:'Shopify Card Reader' },
        { label:'Cost', value:'$49', sub:'Each ($490 total)' },
        { label:'Accepts', value:'3 methods', sub:'Tap, Chip, Swipe' },
        { label:'Connectivity', value:'Bluetooth', sub:'~10 ft range' },
        { label:'Battery', value:'All Day', sub:'USB-C rechargeable' },
        { label:'Backup', value:'Tap to Pay', sub:'iPhone NFC, $0' },
      ].map(s => h('div', { className: 'stat' },
        h('div', { className: 'stat-label' }, s.label),
        h('div', { className: 'stat-value' }, s.value),
        h('div', { className: 'stat-sub' }, s.sub)
      ))
    ),

    h('div', { className: 'section-title' }, 'Pairing Steps (Per Reader)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        ...([
          ['1','Charge reader fully','USB-C cable included'],
          ['2','Open Shopify POS app on distributor\'s iPhone','Must be onboarded first'],
          ['3','Log in with distributor\'s PIN',''],
          ['4','Tap Menu â†’ Settings â†’ Set up hardware â†’ Card reader',''],
          ['5','Power on reader (hold button until LED flashes)',''],
          ['6','Select reader from Bluetooth list in POS app',''],
          ['7','Wait for firmware update if prompted','Do NOT interrupt, up to 10 min'],
          ['8','Process test transaction','Confirm reader works end-to-end'],
          ['9','Label reader with distributor name/ID','Sticker on back'],
        ].map(r => h('div', { className: 'check-row' },
          h('div', { className: 'check-box' + (isChecked('pair'+r[0])?' checked':''), onClick: () => toggleCheck('pair'+r[0]) }),
          h('span', { className: 'check-num' }, r[0]),
          h('span', { className: 'check-label' + (isChecked('pair'+r[0])?' done':'') }, r[1]),
          r[2] ? h('span', { className: 'check-notes' }, r[2]) : null
        )))
      )
    ),

    h('div', { className: 'section-title' }, 'Reader Assignment Tracker'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px', overflowX:'auto' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, '#'),
            ...['Charged','Paired','Firmware','Test Txn','Cable','Labeled'].map(c => h('th', { style: { textAlign:'center' } }, c))
          )),
          h('tbody', null,
            ...(Array.from({length:10}, (_,i) => h('tr', null,
              h('td', { className: 'mono', style: { color:'var(--accent)' } }, ''+(i+1)),
              ...['chrg','pair','fw','test','cable','label'].map(f =>
                h('td', { style: { textAlign:'center' } },
                  h('div', { className: 'check-box' + (isChecked('hw'+i+f)?' checked':''), onClick: () => toggleCheck('hw'+i+f), style: { margin:'0 auto', width:'16px', height:'16px', minWidth:'16px' } })
                )
              )
            )))
          )
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Troubleshooting'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Problem'), h('th', null, 'Fix'))),
          h('tbody', null, ...([
            ['Reader not appearing in POS app','Verify Bluetooth enabled, reader powered on (LED flashing), within 10 ft'],
            ['Pairing fails','Restart both reader and POS app, try again'],
            ['Firmware update stuck','Do NOT power off. Wait 15 min. Contact Shopify support if stuck'],
            ['Test transaction declines','Verify Shopify Payments active (Ticket 8)'],
            ['Reader disconnects mid-sale','Move closer to iPhone. Fall back to Tap to Pay'],
            ['Reader won\'t charge','Try different USB-C cable. Check port for debris'],
          ].map(r => h('tr', null, h('td', { style: { fontWeight:'500', color:'var(--yellow)' } }, r[0]), h('td', null, r[1])))))
        )
      )
    )
  );
}

function renderSubscriptions() {
  return h('div', null,
    h('div', { className: 'section-title' }, 'Subscription Configuration'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Decision'), h('th', null, 'Options'), h('th', null, 'Recommendation'))),
          h('tbody', null, ...([
            ['Subscription app','Shopify Subscriptions (free), ReCharge ($99/mo), Bold','Start with Shopify Subscriptions for pilot'],
            ['Billing frequency','Monthly, Quarterly, Custom','Match existing autoship programs'],
            ['Failed payment retry','1-3 retries over 7-14 days','Match current retry policy'],
            ['Customer notifications','Upcoming renewal, failed payment, card expiring','All enabled'],
            ['Token ownership','Shopify/Stripe owns all tokens','Accepted tradeoff for pilot'],
          ].map(r => h('tr', null, h('td', { style: { fontWeight:'500' } }, r[0]), h('td', null, r[1]), h('td', { style: { color:'var(--green)' } }, r[2])))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Token Lifecycle'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Event'), h('th', null, 'What Happens'), h('th', null, 'Impact'))),
          h('tbody', null, ...([
            ['First POS sale w/ subscription','Card token vaulted via Stripe','Customer enrolled in autoship'],
            ['Renewal date','Sub app creates order, auto-charges vaulted token','No customer action needed'],
            ['Charge fails','Retry per config (1-3 attempts, 7-14 days)','Customer notified to update card'],
            ['Card expires','Card updater service auto-update attempt','May need customer re-entry'],
            ['Customer cancels','Subscription deactivated, token remains','No future charges'],
            ['Leave Shopify platform','All tokens lost (Shopify/Stripe owned)','Customers must re-enter cards'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', null, r[1]),
            h('td', { style: { fontSize:'12px', color: r[0].includes('Leave')?'var(--red)':'var(--text-muted)' } }, r[2])
          ))))
        )
      )
    ),

    h('div', { className: 'info-box warn' },
      h('strong', null, 'Platform lock-in risk: '), 'Shopify/Stripe owns all tokens. If Unicity leaves Shopify, customers must re-enter cards. Accepted tradeoff for pilot. Evaluate at scale.'
    )
  );
}

function renderOnboarding() {
  const distFields = ['PIN Set','POS App','Reader Paired','Test Sale','CSV Verified'];
  const mgrSteps = [
    'Name confirmed','Email confirmed','Store role assigned','Invite sent',
    'Invite accepted (7-day window)','POS role assigned','Location assigned',
    'PIN set','2FA enabled','POS app installed','Reader paired',
    'Admin dashboard tested','Return/refund tested','Staff management tested'
  ];

  return h('div', null,
    h('div', { className: 'section-title' }, 'Distributor Onboarding Tracker'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px', overflowX:'auto' } },
        h('table', null,
          h('thead', null, h('tr', null,
            h('th', null, '#'),
            ...distFields.map(f => h('th', { style: { textAlign:'center' } }, f)),
            h('th', null, 'Status')
          )),
          h('tbody', null,
            ...(Array.from({length:10}, (_,i) => {
              const keys = ['pin','app','reader','sale','csv'].map(k => 'dist'+i+k);
              const done = keys.filter(k => isChecked(k)).length;
              return h('tr', null,
                h('td', { className: 'mono', style: { color:'var(--accent)' } }, ''+(i+1)),
                ...keys.map(k =>
                  h('td', { style: { textAlign:'center' } },
                    h('div', { className: 'check-box' + (isChecked(k)?' checked':''), onClick: () => toggleCheck(k), style: { margin:'0 auto', width:'16px', height:'16px', minWidth:'16px' } })
                  )
                ),
                h('td', null,
                  h('span', { className: 'badge ' + (done===5?'badge-green':done>0?'badge-normal':'') },
                    done===5 ? 'Ready' : done > 0 ? `${done}/5` : 'Pending'
                  )
                )
              );
            }))
          )
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Manager Onboarding Tracker'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        ...mgrSteps.map((step, i) => h('div', { className: 'check-row' },
          h('div', { className: 'check-box' + (isChecked('mgr'+i)?' checked':''), onClick: () => toggleCheck('mgr'+i) }),
          h('span', { className: 'check-num' }, ''+(i+1)),
          h('span', { className: 'check-label' + (isChecked('mgr'+i)?' done':'') }, step)
        ))
      )
    ),

    h('div', { className: 'section-title' }, 'Staff Name â†’ Distributor ID Mapping'),
    h('div', { className: 'info-box' },
      'Shopify CSV exports the staff display name, not the internal staff_id GID. This lookup table maps display names to Unicity IDs for the Unity import.'
    ),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, '#'), h('th', null, 'Shopify Staff Display Name'), h('th', null, 'Unicity Distributor ID'), h('th', { style: { textAlign:'center' } }, 'Verified'))),
          h('tbody', null,
            ...(Array.from({length:10}, (_,i) => h('tr', null,
              h('td', { className: 'mono', style: { color:'var(--accent)' } }, ''+(i+1)),
              h('td', { style: { color:'var(--text-dim)' } }, '[TBD]'),
              h('td', { style: { color:'var(--text-dim)' } }, '[TBD]'),
              h('td', { style: { textAlign:'center' } },
                h('div', { className: 'check-box' + (isChecked('map'+i)?' checked':''), onClick: () => toggleCheck('map'+i), style: { margin:'0 auto', width:'16px', height:'16px', minWidth:'16px' } })
              )
            )))
          )
        )
      )
    )
  );
}

function renderTesting() {
  return h('div', null,
    h('div', { className: 'section-title' }, 'E2E Test Scenarios'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        ...e2eTests.map(t => {
          const done = isChecked(t.id);
          return h('div', { style: { padding:'10px 0', borderBottom:'1px solid rgba(48,54,61,0.4)', display:'flex', gap:'12px', alignItems:'flex-start' } },
            h('div', { className: 'check-box' + (done?' checked':''), onClick: () => toggleCheck(t.id) }),
            h('div', { style: { flex:1 } },
              h('div', { style: { fontWeight:'600', fontSize:'13px', color: done?'var(--text-dim)':'var(--text)', textDecoration: done?'line-through':'none' } }, t.name),
              h('div', { style: { fontSize:'12px', color:'var(--text-muted)', marginTop:'2px' } }, t.steps),
              h('div', { style: { fontSize:'12px', color:'var(--green)', marginTop:'2px' } }, 'Expected: ' + t.expect)
            ),
            h('span', { className: 'badge ' + (done?'badge-green':''), style: { marginTop:'2px' } }, done ? 'PASS' : 'Pending')
          );
        })
      )
    ),

    h('div', { className: 'section-title' }, 'Reconciliation Process'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Check'), h('th', null, 'Frequency'), h('th', null, 'Source A'), h('th', null, 'Source B'), h('th', null, 'Owner'))),
          h('tbody', null, ...([
            ['Order count by distributor','Daily','Shopify Sales by Staff','CSV export totals','Howard'],
            ['Order totals match','Daily','Shopify Orders dashboard','CSV import â†’ Unity','Howard'],
            ['Payment settlement','Per payout','Shopify Payouts report','Bank statement','Howard'],
            ['Subscription renewals','Per billing cycle','Sub app dashboard','Shopify Orders','Howard'],
            ['Failed payments','Daily','Shopify Payments','Sub app retry log','Howard'],
            ['Unity import accuracy','Daily','CSV sent to data team','Unity DB order count','Bryan Simmons'],
          ].map(r => h('tr', null, ...r.map(c => h('td', null, c))))))
        )
      )
    )
  );
}

function renderGoLive() {
  const sections = [
    { key: 'platform', title: 'Platform', icon: 'ðŸ—ï¸' },
    { key: 'hardware', title: 'Hardware (10 Readers)', icon: 'â¬¡' },
    { key: 'roles', title: 'Roles and Access', icon: 'ðŸ”’' },
    { key: 'attribution', title: 'Attribution and Data', icon: 'ðŸ“Š' },
    { key: 'csv', title: 'CSV Export and Unity Import', icon: 'ðŸ“¤' },
    { key: 'subscriptions', title: 'Subscriptions', icon: 'â†»' },
    { key: 'security', title: 'Security', icon: 'ðŸ›¡ï¸' },
    { key: 'testing', title: 'Testing', icon: 'âœ“' },
    { key: 'training', title: 'Training', icon: 'ðŸ“š' },
    { key: 'gonogo', title: 'Go / No-Go', icon: 'ðŸš€' },
  ];

  // Compute overall
  let totalAll = 0, checkedAll = 0;
  sections.forEach(s => {
    goLiveChecks[s.key].forEach((_, i) => { totalAll++; if (isChecked('gl_'+s.key+'_'+i)) checkedAll++; });
  });
  const pctAll = totalAll ? Math.round(checkedAll/totalAll*100) : 0;

  return h('div', null,
    h('div', { className: 'stats', style: { gridTemplateColumns: '1fr' } },
      h('div', { style: { background:'var(--surface2)', border:'1px solid var(--border)', borderRadius:'8px', padding:'16px', textAlign:'center' } },
        h('div', { style: { fontSize:'11px', color:'var(--text-muted)', textTransform:'uppercase', letterSpacing:'0.5px', marginBottom:'8px' } }, 'Go-Live Readiness'),
        h('div', { style: { display:'flex', alignItems:'center', justifyContent:'center', gap:'16px' } },
          h('div', { style: { fontSize:'36px', fontWeight:'700', color: pctAll===100?'var(--green)':pctAll>70?'var(--yellow)':'var(--accent)' } }, pctAll + '%'),
          h('div', { style: { flex:1, maxWidth:'400px' } },
            h('div', { style: { background:'var(--border)', borderRadius:'6px', overflow:'hidden', height:'12px' } },
              h('div', { style: { height:'100%', borderRadius:'6px', width:pctAll+'%', background: pctAll===100?'var(--green)':pctAll>70?'var(--yellow)':'var(--accent)', transition:'width 0.3s' } })
            )
          ),
          h('div', { style: { fontSize:'13px', color:'var(--text-muted)' } }, `${checkedAll} / ${totalAll} items`)
        )
      )
    ),

    ...sections.map(s => checklistCard(
      s.icon + ' ' + s.title,
      'gl_' + s.key,
      goLiveChecks[s.key],
      'gl_' + s.key + '_'
    ))
  );
}

function renderMonitoring() {
  return h('div', null,
    h('div', { className: 'section-title' }, 'Post-Launch Monitoring (First 2 Weeks)'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Metric'), h('th', null, 'Frequency'), h('th', null, 'Owner'), h('th', null, 'Alert Threshold'))),
          h('tbody', null, ...([
            ['Order count reconciliation','Daily','Howard','Any mismatch'],
            ['Attribution accuracy','Daily','Howard','Below 99%'],
            ['Customer email match rate','Daily','Howard','Below 90% Scenario A'],
            ['Payment failure rate','Daily','Howard','Above 3%'],
            ['Subscription renewal success','Per cycle','Howard','Below 90%'],
            ['Card reader connectivity','Daily','Regional Manager','> 2 incidents/day'],
            ['CSV export timeliness','Daily','Howard','Not done by 10 AM'],
            ['Unity import success','Daily','Bryan Simmons','Any import failures'],
            ['Distributor feedback','Weekly','Regional Manager','Any blocking issues'],
            ['Settlement reconciliation','Per payout','Howard','Any discrepancy'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', null, r[1]),
            h('td', null, r[2]),
            h('td', { style: { color:'var(--yellow)', fontSize:'12px' } }, r[3])
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Risks and Mitigations'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Risk'), h('th', null, 'Impact'), h('th', null, 'Likelihood'), h('th', null, 'Mitigation'))),
          h('tbody', null, ...([
            ['Token ownership by Shopify/Stripe','High (lock-in)','Certain','Accepted for pilot. Evaluate at scale.'],
            ['Pricing is store-wide','Medium','Low','Policy enforcement. HQ controls pricing.'],
            ['CSV export missed/delayed','Medium','Low','Backup person + daily calendar reminder'],
            ['Staff name mismatch in mapping','Low','Low','Validate mapping during onboarding'],
            ['Manual CSV doesn\'t scale beyond ~50','Medium','N/A for pilot','Automation path defined'],
            ['Subscription token migration','High (10-20% churn)','N/A','Pilot = new customers only'],
            ['200 location cap','Low','N/A','1 loc. At scale: 200 territories, unlimited dists'],
            ['Card reader Bluetooth','Low','Medium','iPhone Tap to Pay backup'],
            ['9 retail customers at wholesale price','Low','Certain','Shopify Functions or manual POS override. Only 1.2% of customers.'],
            ['Metafield type needs fix (IDâ†’Integer)','Medium','Certain','Delete and recreate custom.customer_id before launch. Write-back will fail without this.'],
            ['Rate negotiation ceiling','Low','Certain','Fixed by Shopify/Stripe. No interchange-plus.'],
            ['Distributor loses/breaks reader','Low','Medium','$49 replacement + Tap to Pay backup'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', null, h('span', { className: 'badge ' + (r[1].startsWith('High')?'badge-high':r[1].startsWith('Medium')?'badge-normal':'badge-green') }, r[1])),
            h('td', { style: { fontSize:'12px' } }, r[2]),
            h('td', { style: { fontSize:'12px', color:'var(--text-muted)' } }, r[3])
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Shopify Admin Quick Reference'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Action'), h('th', null, 'Navigation Path'))),
          h('tbody', null, ...([
            ['Create Location','Settings â†’ Locations â†’ Add location'],
            ['Activate POS Pro','POS channel â†’ Locations â†’ Manage subscriptions'],
            ['Create POS Roles','POS channel â†’ Staff â†’ Manage POS roles'],
            ['Create Store Roles','Settings â†’ Users â†’ Roles â†’ Add role'],
            ['Add Regional Manager','Settings â†’ Users â†’ Add users â†’ "Admin and POS" tab'],
            ['Add Distributor','Settings â†’ Users â†’ Add users â†’ "Point of Sale" tab'],
            ['Assign POS Role','POS channel â†’ Staff â†’ [click name] â†’ Role'],
            ['Pair Card Reader','POS app â†’ Menu â†’ Settings â†’ Set up hardware â†’ Card reader'],
            ['Configure Attribution','POS channel â†’ Settings â†’ Sales attribution'],
            ['Export Orders CSV','Orders â†’ Export'],
            ['View Sales by Staff','POS channel â†’ Analytics â†’ Sales by staff'],
            ['Manage Subscriptions','Apps â†’ [Subscription app]'],
            ['Check Payouts','Settings â†’ Payments â†’ View payouts'],
            ['Customer Metafields','Settings â†’ Metafields and metaobjects â†’ Customers'],
            ['Import Customers CSV','Customers â†’ Import'],
            ['Product Pricing','Products â†’ [Product Name] â†’ Price / Compare at'],
            ['Customer List (711 MS)','Customers'],
          ].map(r => h('tr', null,
            h('td', { style: { fontWeight:'500' } }, r[0]),
            h('td', { className: 'mono', style: { fontSize:'12px' } }, r[1])
          ))))
        )
      )
    ),

    h('div', { className: 'section-title' }, 'Related Tickets'),
    h('div', { className: 'card' },
      h('div', { className: 'card-body', style: { paddingTop:'16px' } },
        h('table', null,
          h('thead', null, h('tr', null, h('th', null, 'Ticket'), h('th', null, 'Title'), h('th', null, 'Relationship'))),
          h('tbody', null,
            h('tr', null, h('td', null, 'TKT-5784'), h('td', null, 'Shopify - USA - POS'), h('td', null, 'Parent initiative')),
            h('tr', null, h('td', null, 'TKT-5656'), h('td', null, 'Shopify Payments + Shop Pay Implementation'), h('td', null, 'Payment platform')),
            h('tr', null, h('td', null, 'TKT-5793'), h('td', null, 'Shopify POS Distributor Pilot (this epic)'), h('td', null, '23 active + 2 descoped')),
            h('tr', null, h('td', null, '86dzugv8m'), h('td', null, 'Shopify-Unity Order Sync Automation'), h('td', null, 'Subtask, due Mar 7'))
          )
        )
      )
    )
  );
}

const panelRenderers = [
  renderOverview, renderPayments, renderDataFlow, renderPermissions, renderTickets, renderSprint,
  renderHardware, renderSubscriptions, renderOnboarding, renderTesting, renderGoLive, renderMonitoring
];

// ================================================
// MAIN RENDER
// ================================================
function render() {
  // Update global progress
  document.getElementById('globalProgress').textContent = getGlobalProgress() + '%';
  document.getElementById('ticketProgress').textContent = getTicketProgress() + '%';

  // Tabs
  const tabBar = document.getElementById('tabBar');
  tabBar.innerHTML = '';
  tabs.forEach((t, i) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (i === state.activeTab ? ' active' : '');
    tab.textContent = t.label;
    tab.onclick = () => setTab(i);
    tabBar.appendChild(tab);
  });

  // Panels
  const main = document.getElementById('mainContent');
  main.innerHTML = '';
  main.appendChild(panelRenderers[state.activeTab]());
}

// Initial render (read tab from URL hash)
state.activeTab = getTabFromHash();
render();
</script>
</body>
</html>
